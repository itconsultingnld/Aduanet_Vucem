<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Page Title</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<style>
    body {
        background-color: black;
        color: white;
        margin: 5px;
    }

    a {
        color: dodgerblue;
    }
</style>

<body>
    <div>
        <input type="file" id="fileInput" accept="application/pdf" />
        <button onclick="cargarPDF()">Cargar PDF</button>
        <button onclick="convertirVucem()">CONVERTIDOR VUCEM</button>
    </div>
    <!-- Contenedor para mostrar el PDF -->
    <div style="margin-top: 10px;" style="width: 70%; margin: 0 auto; padding-left: 30%;" class="row">
        <div id="pdfViewer1" class="col-6"></div>
        <div id="pdfViewer2" class="col-6"></div>
    </div>
    <script>
        let pdfDoc; // Almacena el documento PDF cargado
        let base64data;

        async function cargarPDF() {
            const inputFile = document.getElementById('fileInput');
            const archivo = inputFile.files[0];

            if (!archivo && !archivo.type === 'application/pdf') {
                return alert('Por favor, selecciona un archivo PDF válido.');
            }
            const arrayBuffer = await archivo.arrayBuffer();

            // Cargar el PDF en pdf-lib
            pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);

            // Generar el nuevo PDF y descargarlo
            const pdfBytes = await pdfDoc.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });

            var reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onload = async function (event) {
                pdfDoc = await PDFLib.PDFDocument.load(event.target.result);
            };
            // reader.readAsArrayBuffer(blob);
            reader.onloadend = function () {
                base64data = reader.result;
                console.log(base64data);

                // Mostrar el PDF en el visor (solo como información)
                const pdfViewer = document.getElementById('pdfViewer1');
                pdfViewer.innerHTML = `<embed src="${base64data}" type="application/pdf" width="100%" height="500px" />`;
            }
        }

        function convertirVucem() {
            let datos = { "archivo": base64data };
            var request = new XMLHttpRequest();
            request.open('POST', "http://localhost/Aduanet_Vucem/API/app_ws/Convertidor/convertir", true);
            request.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            // Load the data directly as a Blob.
            // request.responseType = 'blob';
            request.send(JSON.stringify(datos));
            request.onload = async function () {

                // Mostrar el PDF en el visor (solo como información)
                // const fileURL = URL.createObjectURL(request.response);
                const pdfViewer = document.getElementById('pdfViewer2');
                // pdfViewer.innerHTML = `<embed src="${fileURL}" type="application/pdf" width="100%" height="500px" />`;
                pdfViewer.innerHTML = `<embed src="data:application/pdf;base64,${request.response}" type="application/pdf" width="100%" height="500px" />`;
            };
        }
    </script>
    <script src="./js/pdf-lib.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
</body>

</html>